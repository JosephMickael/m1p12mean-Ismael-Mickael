<div class="container mt-5">
  <h2 class="text-center mb-4">Gestion de devis</h2>

  <!-- Affichage pour les clients -->
  <div *ngIf="userRole == 'client'">
    <!-- Liste des devis -->
    <div class="card shadow-sm">
      <div class="card-header bg-info text-white">
        <h3 class="m-0">Liste des devis</h3>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-bordered table-hover">
            <thead class="thead-dark">
              <tr>
                <th>M√©canicien</th>
                <th>Services</th>
                <th>Co√ªt des services</th>
                <th>Status</th>
                <th>Pi√®ces</th>
                <th>Prix HT</th>
                <th>Prix TTC</th>
                <th>Total g√©n√©ral</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let d of devis">
                <td>{{ d.mecanicien?.nom }}</td>
                <td>
                  <ul class="list-unstyled">
                    <li *ngFor="let service of d.services">
                      {{ service.description }}
                    </li>
                  </ul>
                </td>
                <td>
                  <ul class="list-unstyled">
                    <li *ngFor="let service of d.services">
                      {{ service.coutServices }} 
                    </li>
                  </ul>
                </td>
                <td>{{ d.status }}</td>
                <td>
                  <ul class="list-unstyled">
                    <li *ngFor="let piece of d.pieces">
                      {{ piece.nom }} ({{ piece.quantite }} x {{ piece.prixUnitaireTTC }} )
                    </li>
                  </ul>
                </td>
                <td>
                  <ul class="list-unstyled">
                    <li *ngFor="let piece of d.pieces">
                      {{ piece.prixUnitaireHT }} 
                    </li>
                  </ul>
                </td>
                <td>
                  <ul class="list-unstyled">
                    <li *ngFor="let piece of d.pieces">
                      {{ piece.prixUnitaireTTC }} 
                    </li>
                  </ul>
                </td>
                <td>{{ d.totalGeneral }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  

  <!-- Affichage pour les m√©caniciens -->
  <div *ngIf="userRole == 'mecanicien'">
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h3>Cr√©er un nouveau devis</h3>
      </div>
      <div class="card-body">
        <form (ngSubmit)="creerDevis()">
          <div class="form-group">
            <label for="clientControl" class="form-label">Nom du client</label>
            <input 
              type="text" 
              class="form-control" 
              id="clientControl" 
              placeholder="Entrez un nom de client" 
              [formControl]="clientControl"
              (focus)="showDropdown = true">
            <ul *ngIf="showDropdown && (filteredUsers$ | async) as filteredUsers" 
                class="list-group custom-dropdown">
              <li *ngFor="let client of filteredUsers" 
                  class="list-group-item list-group-item-action"
                  (click)="selectUser(client)">
                {{ client.nom }}
              </li>
            </ul>
          </div>

          <!-- Champs pour services -->
          <div class="form-group">
            <label for="services">Services:</label>
            <textarea type="text" class="form-control" [(ngModel)]="newDevis.services[0].description" name="description" required></textarea>
          </div>
          <div class="form-group">
            <label for="coutServices">Co√ªt des services :</label>
            <input type="number" class="form-control" [(ngModel)]="newDevis.services[0].coutServices" name="coutServices" (input)="calculTotal()" required>
          </div>

          <!-- Composant Pi√®ces -->
          <app-pieces (pieceAdded)="onPieceAdded($event)"></app-pieces>

          <!-- Liste des pi√®ces ajout√©es -->
          <label>Pi√®ces du Devis</label>
          <table>
            <thead>
              <tr>
                <th>Nom</th>
                <th>R√©f√©rence</th>
                <th>Prix HT</th>
                <th>Prix TTC</th>
                <th>Quantit√©</th>
                <th>Total</th>
                <th>Actions</th> 
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let piece of newDevis.pieces; let i = index">
                <td>{{ piece.nom }}</td>
                <td>{{ piece.reference }}</td>
                <td>{{ piece.prixUnitaireHT }}</td>
                <td>{{ piece.prixUnitaireTTC }}</td>
                <td>{{ piece.quantite }}</td>
                <td>{{ piece.total }}</td>
                <td>
                  <button (click)="removePiece(i)">üóë Supprimer</button>
                </td>
              </tr>
            </tbody>
          </table>

          <div class="form-group">
            <label for="totalGeneral"><strong>Total G√©n√©ral :</strong></label>
            <input type="number" class="form-control" [(ngModel)]="newDevis.totalGeneral" name="totalGeneral" readonly>
          </div>

          <button type="submit" class="btn btn-success mt-3">Cr√©er le devis</button>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-header bg-info text-white">
        <h3>Liste des devis</h3>
      </div>
      <div class="card-body">
        <table class="table table-bordered">
          <thead class="thead-dark">
            <tr>
              <th>Client</th>
              <th>Services</th>
              <th>Status</th>
              <th>Total g√©n√©rale </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let d of devis">
              <td>{{ d.client.nom }}</td>
              <td>
                <ul>
                  <li *ngFor="let service of d.services">
                    {{ service.description }}
                  </li>
                </ul>
              </td>
              <td>{{ d.status }} </td>
              <td>{{ d.totalGeneral }} </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Affichage pour les managers -->
  <div *ngIf="userRole == 'manager'">
    <!-- Liste des devis avec actions -->
    <div class="card">
      <div class="card-header bg-info text-white">
        <h3>Liste des devis</h3>
      </div>
      <div class="card-body">
        <table class="table table-bordered">
          <thead class="thead-dark">
            <tr>
              <th>Client</th>
              <th>Services</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let d of devis">
              <td>{{ d.client.nom }}</td>
              <td>
                <ul>
                  <li *ngFor="let service of d.services">
                    {{ service.description }}
                  </li>
                </ul>
              </td>
              <td>{{ d.status }} </td>
              <td>
                <button class="btn btn-warning btn-sm" (click)="selectDevis(d)">Modifier</button>
                <button class="btn btn-success btn-sm" (click)="validerDevis(d._id)">Valider</button>
                <button class="btn btn-danger btn-sm" (click)="supprimerDevis(d._id)">Supprimer</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Formulaire de modification de devis -->
    <div *ngIf="selectedDevis" class="card mt-4">
      <div class="card-header bg-warning text-white">
        <h3>Modifier un devis</h3>
      </div>
      <div class="card-body">
        <form (ngSubmit)="modifierDevis(selectedDevis._id)">
          <div class="form-group">
            <label for="client">Client:</label>
            {{ selectedDevis.client?.nom }}
          </div>
          <div class="form-group">
            <label for="mecanicien">M√©canicien:</label>
            {{ selectedDevis.mecanicien?.nom }}
          </div>

          <!-- Affichage et modification de services -->
          <div *ngFor="let service of selectedDevis.services; let i = index">
            <div class="form-group">
              <label for="serviceDescription{{i}}">D√©scription du service :</label>
              <input 
                type="text" 
                class="form-control" 
                [(ngModel)]="selectedDevis.services[i].description" 
                [name]="'serviceDescription' + i" 
                required>
            </div>

            <div class="form-group">
              <label for="serviceCoutServices{{i}}">Co√ªt du service :</label>
              <input 
                type="number" 
                class="form-control" 
                [(ngModel)]="selectedDevis.services[i].coutServices"  
                [name]="'serviceCoutServices' + i" 
                required>
            </div>
          </div>

          <!-- Affichage et modification de pi√®ces -->
          <div class="form-group">
            <label for="pieces">Pi√®ces:</label>
            <div *ngFor="let piece of selectedDevis.pieces; let j = index">
              <div class="row">
                <div class="col-4">
                  <input 
                    type="text" 
                    class="form-control" 
                    [(ngModel)]="piece.nom" 
                    name="pieceNom-{{j}}" 
                    required>
                </div>
                <div class="col-4">
                  <input 
                    type="text" 
                    class="form-control" 
                    [(ngModel)]="piece.reference" 
                    name="pieceReference-{{j}}" 
                    required>
                </div>
                <div class="col-4">
                  <input 
                    type="number" 
                    class="form-control" 
                    [(ngModel)]="piece.prixUnitaireHT" 
                    name="piecePrixUnitaireHT-{{j}}" 
                    (input)="calculTotal()"
                    required>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="totalGeneral"><strong>Total G√©n√©ral :</strong></label>
              <input type="number" class="form-control" [(ngModel)]="newDevis.totalGeneral" name="totalGeneral" readonly>
            </div>      
          </div>

          <button type="submit" class="btn btn-warning mt-3">Mettre √† jour le devis</button>
        </form>
      </div>
    </div>
  </div>
</div>
